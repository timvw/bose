name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to build
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  validate:
    name: Validate version alignment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Validate tag matches crate version
        run: |
          set -euo pipefail
          if [ -z "${RELEASE_TAG:-}" ]; then
            echo "::error::RELEASE_TAG is empty; expected a tag like v0.0.0" >&2
            exit 1
          fi

          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "$TAG_VERSION" = "$RELEASE_TAG" ]; then
            echo "::error::Release tag \"$RELEASE_TAG\" must start with v (e.g. v0.2.3)" >&2
            exit 1
          fi

          MANIFEST_VERSION=$(cargo metadata --format-version 1 --no-deps --locked | jq -r '.packages[] | select(.name == "bose") | .version')
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Cargo.toml version $MANIFEST_VERSION does not match tag $RELEASE_TAG. Bump with: cargo set-version $TAG_VERSION && cargo update -p bose --precise $TAG_VERSION" >&2
            exit 1
          fi

          LOCK_VERSION=$(python - <<'PY'
import pathlib, sys
lines = pathlib.Path("Cargo.lock").read_text().splitlines()
for idx, line in enumerate(lines):
    if line.strip() == 'name = "bose"':
        for next_line in lines[idx + 1 : idx + 6]:
            stripped = next_line.strip()
            if stripped.startswith("version = "):
                version = stripped.split("=", 1)[1].strip().strip('"')
                print(version)
                sys.exit(0)
        break
sys.exit("Package bose not found in Cargo.lock")
PY
)
          if [ "$LOCK_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Cargo.lock version $LOCK_VERSION does not match tag $RELEASE_TAG. Run: cargo update -p bose --precise $TAG_VERSION" >&2
            exit 1
          fi

          echo "Release tag $RELEASE_TAG matches Cargo.toml/Cargo.lock version $TAG_VERSION"

  linux:
    name: Linux x86_64
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: cargo build --locked --release --target x86_64-unknown-linux-gnu

      - name: Verify binary version output
        run: |
          set -euo pipefail
          TAG_VERSION="${RELEASE_TAG#v}"
          ./target/x86_64-unknown-linux-gnu/release/bose --version | grep -F "bose $TAG_VERSION"

      - name: Package
        run: |
          set -euo pipefail
          ARTIFACT="bose-${RELEASE_TAG}-x86_64-unknown-linux-gnu"
          STAGING="dist/$ARTIFACT"
          rm -rf dist
          mkdir -p "$STAGING"
          cp "target/x86_64-unknown-linux-gnu/release/bose" "$STAGING/"
          strip "$STAGING/bose"
          cp README.md LICENSE "$STAGING/"
          (cd dist && tar -czf "$ARTIFACT.tar.gz" "$ARTIFACT")

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: linux
          path: dist/bose-${{ env.RELEASE_TAG }}-x86_64-unknown-linux-gnu.tar.gz

  macos:
    name: macOS universal
    runs-on: macos-latest
    needs: validate
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Build per-arch binaries
        run: |
          set -euo pipefail
          for target in aarch64-apple-darwin x86_64-apple-darwin; do
            cargo build --locked --release --target "$target"
          done

      - name: Create universal binary
        run: |
          set -euo pipefail
          mkdir -p target/universal
          lipo -create \
            target/aarch64-apple-darwin/release/bose \
            target/x86_64-apple-darwin/release/bose \
            -output target/universal/bose
          strip -x target/universal/bose

      - name: Package
        run: |
          set -euo pipefail
          ARTIFACT="bose-${RELEASE_TAG}-apple-darwin-universal"
          STAGING="dist/$ARTIFACT"
          rm -rf dist
          mkdir -p "$STAGING"
          cp target/universal/bose "$STAGING/bose"
          cp README.md LICENSE "$STAGING/"
          (cd dist && tar -czf "$ARTIFACT.tar.gz" "$ARTIFACT")

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: macos
          path: dist/bose-${{ env.RELEASE_TAG }}-apple-darwin-universal.tar.gz

  windows:
    name: Windows x86_64
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: cargo build --locked --release --target x86_64-pc-windows-msvc

      - name: Package
        shell: pwsh
        run: |
          $artifact = "bose-${{ env.RELEASE_TAG }}-x86_64-pc-windows-msvc"
          Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
          $staging = "dist/$artifact"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Copy-Item "target/x86_64-pc-windows-msvc/release/bose.exe" "$staging/bose.exe"
          Copy-Item @("README.md", "LICENSE") -Destination $staging
          Compress-Archive -Path "$staging/*" -DestinationPath "dist/$artifact.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: windows
          path: dist/bose-${{ env.RELEASE_TAG }}-x86_64-pc-windows-msvc.zip

  publish:
    name: Publish release
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows
    steps:
      - name: Download linux artifact
        uses: actions/download-artifact@v6
        with:
          name: linux
          path: dist

      - name: Download mac artifact
        uses: actions/download-artifact@v6
        with:
          name: macos
          path: dist

      - name: Download windows artifact
        uses: actions/download-artifact@v6
        with:
          name: windows
          path: dist

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
        env:
          GITHUB_TOKEN: ${{ github.token }}
