name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to build
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RELEASE_TAG: ${{ github.ref_name }}

jobs:
  linux:
    name: Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: cargo build --locked --release --target x86_64-unknown-linux-gnu

      - name: Package
        run: |
          set -euo pipefail
          ARTIFACT="bose-${RELEASE_TAG}-x86_64-unknown-linux-gnu"
          STAGING="dist/$ARTIFACT"
          rm -rf dist
          mkdir -p "$STAGING"
          cp "target/x86_64-unknown-linux-gnu/release/bose" "$STAGING/"
          strip "$STAGING/bose"
          cp README.md LICENSE "$STAGING/"
          (cd dist && tar -czf "$ARTIFACT.tar.gz" "$ARTIFACT")

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: bose-${{ env.RELEASE_TAG }}-x86_64-unknown-linux-gnu.tar.gz

  macos:
    name: macOS universal
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      - name: Build per-arch binaries
        run: |
          set -euo pipefail
          for target in aarch64-apple-darwin x86_64-apple-darwin; do
            cargo build --locked --release --target "$target"
          done

      - name: Create universal binary
        run: |
          set -euo pipefail
          mkdir -p target/universal
          lipo -create \
            target/aarch64-apple-darwin/release/bose \
            target/x86_64-apple-darwin/release/bose \
            -output target/universal/bose
          strip -x target/universal/bose

      - name: Package
        run: |
          set -euo pipefail
          ARTIFACT="bose-${RELEASE_TAG}-apple-darwin-universal"
          STAGING="dist/$ARTIFACT"
          rm -rf dist
          mkdir -p "$STAGING"
          cp target/universal/bose "$STAGING/bose"
          cp README.md LICENSE "$STAGING/"
          (cd dist && tar -czf "$ARTIFACT.tar.gz" "$ARTIFACT")

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: bose-${{ env.RELEASE_TAG }}-apple-darwin-universal.tar.gz

  windows:
    name: Windows x86_64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: cargo build --locked --release --target x86_64-pc-windows-msvc

      - name: Package
        shell: pwsh
        run: |
          $artifact = "bose-${{ env:RELEASE_TAG }}-x86_64-pc-windows-msvc"
          Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
          $staging = "dist/$artifact"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Copy-Item "target/x86_64-pc-windows-msvc/release/bose.exe" "$staging/bose.exe"
          Copy-Item README.md LICENSE -Destination $staging
          Compress-Archive -Path "$staging/*" -DestinationPath "dist/$artifact.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: bose-${{ env.RELEASE_TAG }}-x86_64-pc-windows-msvc.zip

  publish:
    name: Publish release
    runs-on: ubuntu-latest
    needs:
      - linux
      - macos
      - windows
    steps:
      - name: Download linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux
          path: dist

      - name: Download mac artifact
        uses: actions/download-artifact@v4
        with:
          name: macos
          path: dist

      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: dist

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
        env:
          GITHUB_TOKEN: ${{ github.token }}
